/*
 * Copyright (C) 2017 Greg Higgins (greg.higgins@V12technology.com)
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package com.fluxtion.visualiser.extensions.audit;

import java.util.List;
import java.util.Map;
import java.util.concurrent.atomic.LongAdder;
import java.util.stream.Collectors;

/**
 * Parses log records from a map structure as generated by a yaml generator. See
 *
 * com.rbccm.fx.dto.log.LogRecord for an example of generating yaml in the
 * required form.
 * @author Greg Higgins (greg.higgins@V12technology.com)
 * @version $Id: $Id
 */
public class EventLog {

    private Map map;
    private List<AuditRecord> auditList;
    private List<String> nodeNameList;

    /**
     * <p>Constructor for EventLog.</p>
     *
     * @param map a {@link java.util.Map} object.
     */
    public EventLog(Map map) {
        setMap(map);
    }

    /**
     * <p>Setter for the field <code>map</code>.</p>
     *
     * @param map a {@link java.util.Map} object.
     */
    public final void setMap(Map map) {
        this.map = map;
        auditList = null;
        nodeNameList = null;
    }

    /**
     * <p>getLogTime.</p>
     *
     * @return a long.
     */
    public long getLogTime() {
        return (long) map.get("logTime");
    }

    /**
     * <p>getGroupingId.</p>
     *
     * @return a {@link java.lang.String} object.
     */
    public String getGroupingId() {
        return (String) map.get("groupingId");
    }

    /**
     * <p>getEventType.</p>
     *
     * @return a {@link java.lang.String} object.
     */
    public String getEventType() {
        return (String) map.get("event");
    }

    /**
     * <p>nodeLogs.</p>
     *
     * @return a {@link java.util.List} object.
     */
    public List< Map> nodeLogs() {
        return (List< Map>) map.get("nodeLogs");
    }

    /**
     * <p>getAuditLogs.</p>
     *
     * @return a {@link java.util.List} object.
     */
    public List< AuditRecord> getAuditLogs() {
        if (auditList == null) {
            LongAdder accumulator = new LongAdder();
            auditList = ((List< Map>) map.get("nodeLogs")).stream().map(m -> {
                Map.Entry entry = (Map.Entry) m.entrySet().iterator().next();
                final AuditRecord auditRecord = new AuditRecord(entry, accumulator.intValue());
                accumulator.increment();
                return auditRecord;
            }).collect(Collectors.toList());
        }
        return auditList;
    }

    /**
     * <p>nodeNames.</p>
     *
     * @return a {@link java.util.List} object.
     */
    public List<String> nodeNames() {
        if (nodeNameList == null) {
            nodeNameList = (List<String>) nodeLogs()
                    .stream()
                    .flatMap(f -> f.keySet().stream())
                    .map(k -> (String) k)
                    .distinct()
                    .collect(Collectors.toList());
        }
        return nodeNameList;
    }

    /**
     * <p>logCount.</p>
     *
     * @return a int.
     */
    public int logCount() {
        return nodeLogs().size();
    }

    /** {@inheritDoc} */
    @Override
    public String toString() {
        return "EventLog{"
                + "logTime=" + getLogTime()
                + ", groupingId=" + getGroupingId()
                + ", event=" + getEventType()
                + ", logCount=" + logCount()
                + ", auditLogs=" + getAuditLogs()
                + ", nodeLogs=" + nodeLogs()
                + ", nodeNames=" + nodeNames()
                + '}';
    }

    public static class AuditRecord {

        private final String nodeId;
        private final Map propertyMap;
        private final int sequenceNumber;

        public AuditRecord(String nodeId, Map propertyMap, int sequenceNumber) {
            this.nodeId = nodeId;
            this.propertyMap = propertyMap;
            this.sequenceNumber = sequenceNumber;
        }

        public AuditRecord(Map.Entry entry, int sequenceNumber) {
            this.nodeId = (String) entry.getKey();
            this.propertyMap = (Map) entry.getValue();
            this.sequenceNumber = sequenceNumber;
        }

        public String getNodeId() {
            return nodeId;
        }

        public Map getPropertyMap() {
            return propertyMap;
        }

        public int getSequenceNumber() {
            return sequenceNumber;
        }

        @Override
        public String toString() {
            return "AuditRecord{"
                    + "nodeId=" + nodeId
                    + ", sequenceNumber=" + sequenceNumber
                    + ", propertyMap=" + propertyMap
                    + '}';
        }

    }


}
